{% extends "layout-bs4.njk" %}

{% set title = "template debugging" %}

{% block content %}

    <div class="row">
        <div class="col-sm-1"></div>
        <div class="col-sm-11">
            <h1 <i class="fa fa-align-center" aria-hidden="true"></i>>VAGOAMIN - Vara de Goiabeira no meio ambientalmente incorreto</h1>
            <div class="row">
                <span id='current-user'>Bem-vindo:</span>
                <span>
                    <div class="form-group">
                        <label for="user-css">Escolha seu tema</label>
                        <select class="class-form-control" name="user-css" id="user-css">
                            <option>claro</option>
                            <option>escuro</option>
                        </select>
                    </div>
                </span>
            </div>
            <div class="row">
                <div class="col-3">
                    <div class="class-card">
                        <div class="class-card-header d-flex">
                            <span>
                    Unidades
                    </span>
                            <span class="class-list-actions float-right m-0">
                                <i class="far fa-trash-alt"
                            onclick="dlgDeleteUnit()"
                            data-toggle="modal"
                            data-target="#deleteFoodModal"></i>
                                <i class="fas fa-pencil-alt"
                            onclick="dlgUpdateUnit()"
                            data-toggle="modal"
                            data-target="#formUnitModal"></i>
                                <i class="fas fa-plus"
                            id="createUnitBtn"
                            data-toggle="modal"
                            data-target="#formUnitModal"
                            onclick="dlgEditNewUnit()"></i>
                            </span>
                        </div>
                        <div class="class-list-card-body d-flex">
                            <select
                            multiple
                            {# BUG - nem a pau apenas class-form-control d-flex deu certo #}
                            class="form-control d-flex"
                            name="unitList"
                            id="unitList"
                        >
                                {% for unit in units %}
                                    <option id="{{unit.id}}">{{unit.name}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="class-card-footer text-muted">Adm. por:........</div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="class-card">
                        <div class="class-card-header d-flex">Computadores
                                            </span>
                        <span class="class-list-actions float-right m-0">
                            <i class="fas fa-power-off"
                            id="powerHostBtn"
                            data-toggle="modal"
                            data-target="#formPowerModal"
                            onclick="dlgPowerHost()"></i>
                            <i class="fas fa-trash-alt"
                            onclick="dlgDeleteHost()"
                            data-toggle="modal"
                            data-target="#deleteHostModal"></i>
                            <i class="fas fa-pencil-alt"
                            onclick="dlgUpdateHost()"
                            data-toggle="modal"
                            data-target="#formHostModal"></i>
                            <i class="fas fa-plus"
                            id="createUnitBtn"
                            data-toggle="modal"
                            data-target="#formHostModal"
                            onclick="dlgEditNewHost()"></i>
                        </span>
                    </div>
                    <div class="class-list-card-body d-flex"></div>
                    <select                             multiple
                            {# BUG - nem a pau apenas class-form-control d-flex deu certo #}
                            class="form-control d-flex"
                            name="hostList"
                            id="hostList"
                ></select>
                    <div class="class-card-footer text-muted">Total: 0/0</div>
                </div>
            </div>
            <div class="col-5">
                <div class="class-card">
                    <div class="class-card-header d-flex">
                        Habilitados
                        <span class="class-list-actions float-right m-0">
                            <i class="fas fa-power-off"
                            id="createUnitBtn"
                            data-toggle="modal"
                            data-target="#formUnitModal"
                            onclick="dlgEditNewUnit()"></i>
                            <i class="fas fa-ban"
                            onclick="dlgUpdateUnit()"
                            data-toggle="modal"
                            data-target="#formUnitModal"></i>
                        </span>
                    </div>
                    <div class="class-list-card-body d-flex" >
                        <select                             multiple
                            {# BUG - nem a pau apenas class-form-control d-flex deu certo #}
                            class="form-control d-flex"
                            name="hostEnableList"
                            id="hostEnableList"
                ></select>
                    </div>
                    <div class="class-card-footer text-muted">Total: 0/0</div>
                </div>
            </div>
        </div>
        <div class="col-sm-2">
            {# margem direita #}
        </div>
    </div>
    <div class="row" >
        {# separador depuração #}
        <br><br><br><br><br><br><br>
    </div>

    <form id="formUnit">
        <div class="modal fade" id="formUnitModal" tabindex="-1" aria-labelledby="formUnitLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="formUnitLabel"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="unit-name">Nome da unidade</label>
                            <input type="text" class="form-control" id="unit-name" name="name">
                        </div>
                        <div class="form-group">
                            <label for="unit-admId">Administrada por:</label>
                            <select class="form-control" id="unit-admId" name="admId">
                                <option>null</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="unit-max_on">Estações liberadas:</label>
                            <select class="form-control" id="unit-max_on" name="max_on">
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        <button type="submit" class="btn btn-primary">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <form id="formHost">
        <div class="modal fade" id="formHostModal" tabindex="-1" aria-labelledby="formHostLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="formHostLabel"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="host-name">Nome do host</label>
                            <input type="text" class="form-control" id="host-name" name="name">
                        </div>
                        <div class="form-group">
                            <label for="host-ipv4">IPV4:</label>
                            <select class="form-control" id="host-ipv4" name="ipv4">
                                <option>null</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="host-ipv4">MAC:</label>
                            <select class="form-control" id="host-mac" name="mac">
                                <option>null</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                        <button type="submit" class="btn btn-primary">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>
    </form>

</div>
<script type="module">
    window.addEventListener('DOMContentLoaded', (event) => {
        var accessTokenObj = localStorage.getItem("@vagoaminApp:token");
        if (!accessTokenObj) {
            location.href = '/signin.html';
            window.redirect('signin.html');
        }
    });

    //!serviços rest
    import clientapi from './js/rest/clientapi.js';
    var globalUnitID = -1;
    const globalUnitList = document.querySelector('#unitList');
    const globalHostList = document.querySelector('#hostList');
    const globalAlwaysOnList = document.querySelector('#hostList');
    const globalStyleList = document.getElementById('user-css');

    //script para eventos
    async function dlgDeleteUnit() {
        if (globalUnitID >= 0) {
            const itemName = globalUnitList
                .options[globalUnitList.selectedIndex]
                .innerHTML;
            if (confirm(`Confirma a remoção da unidade(${itemName})?`)) {
                console.log('Thing was not saved to the database.');
                const ret = await clientapi.destroy(`/units/${globalUnitID}`);
                globalUnitList
                    .options[globalUnitList.selectedIndex]
                    .remove();
                globalUnitID = -1
            }
        } else {
            alert('Selecione a unidade para realizar a operação');
        }
    }

    globalUnitList.addEventListener("change", (event) => {
        //talvez seja necessario adiantar a alteração do item selecionado
        //1 - remove do atual $(".list-group .list-group-item").removeClass("active");
        //2  passa para o novo $(e.target).addClass("active");
        const key = event
            .target
            .options[event.target.selectedIndex]
            .getAttribute('id');
        if (key) {
            globalUnitID = key;
            loadHostList(key);
        } else {
            globalUnitID = -1;
            alert('Chave inválida');
        }
    });

    async function signout() {
        await fetch('/signout');
        localStorage.removeItem('@vagoaminApp:token');
        location.href = '/signin.html';
    }

    function insertHostItem(ctl, host) {
        const hostItem = `<option id="${host.id}">${host.name}</option>`;
        ctl.insertAdjacentHTML('beforeend', hostItem);
    }

    function loadFormValues(title, unitName, unitAdm) {
        const formLabel = document.querySelector('#formUnitLabel');
        const unitNameInput = document.querySelector('#unit-name');
        const unitAdmSelect = document.querySelector('#unit-admId');

        formLabel.innerHTML = title;
        unitNameInput.value = unitName;
        Array
            .from(unitAdmSelect.options)
            .forEach((option, index) => {
                if (option.innerHTML === unitAdm) 
                    unitAdmSelect.value = index + 1;
                }
            )
    }

    function insertUserItem(ctl, user, admId) {
        if (admId == user.id) {
            var userItem = `<option id="${user.id}" selected>${user.login}</option>`;
        } else {
            var userItem = `<option id="${user.id}">${user.login}</option>`;
        }
        ctl.insertAdjacentHTML('beforeend', userItem);
    }

    async function loadHostList(key) {
        const hlist = document.getElementById('hostList');
        hlist.innerHTML = '';
        //todo validar agora
        const hosts = await clientapi.read(`/hosts/unit/${key}`);
        for (const host of hosts) {
            insertHostItem(hlist, host);
        }
    }

    function createUnitView(newUnit) {
        const unitView = document.getElementById('unitList');
        unitView.insertAdjacentHTML('beforeend', `<option id="${newUnit.id}"> ${newUnit.name}</option>`);
    }

    async function dlgEditNewUnit() {
        const formUnit = document.querySelector('#formUnit');
        //carga dos usuários para lista de adms
        var users = await clientapi.read(`/users`);
        const ctl = formUnit.querySelector('#unit-admId');
        ctl.innerHTML = '';
        for (const user of users) {
            insertUserItem(ctl, user);
        }
        loadFormValues('Criação de unidade', '', '');
        formUnit.onsubmit = async (e) => {
            e.preventDefault();
            let unit = Object.fromEntries(new FormData(formUnit));
            //HACK recupera id pelo login
            unit.admId = users
                .find(o => o.login === unit.admId)
                .id; //reverso para pegar o id pelo login
            try {
                var newUnit = await clientapi.create('/units', unit);
            } catch (err) {
                alert(`Falha salvando nova unidade: ${err}`);
            }
            createUnitView(newUnit); //insere entrada na lista de unidades
            $('#formUnitModal').modal('toggle');
            document
                .querySelector('#createUnitBtn')
                .blur();
        };
    }

    async function dlgUpdateUnit() {
        const formUnit = document.querySelector('#formUnit');
        try {
            var unit = await clientapi.read(`/units/${globalUnitID}`);
        } catch (err) {
            alert(`Erro recuperado os dados( ${err} )`);
        }
        const users = await clientapi.read(`/users`);
        const ctl = formUnit.querySelector('#unit-admId');
        ctl.innerHTML = '';
        for (const user of users) {
            insertUserItem(ctl, user, unit.adm_id);
        }
        loadFormValues('Editar unidade', unit.name, unit.admId);
        formUnit.onsubmit = (e) => {
            e.preventDefault();
            const unit = Object.fromEntries(new FormData(formUnit));
            //HACK recupera id pelo login
            unit.admId = users
                .find(o => o.login === unit.admId)
                .id; //reverso para pegar o id pelo login
            clientapi.update(`/units/${globalUnitID}`, unit);
            //updateUnitView({ id, ...unit });
            updateUnitView(unit);
            $('#formUnitModal').modal('toggle');
        }
    }

    function updateUnitView(unit) {
        const item = globalUnitList.options[globalUnitList.selectedIndex];
        item.innerHTML = unit.name;
    }

    function dlgPowerHost() {
        alert(`Serviço Wake-on-LAN(WOL) será acionado para o host informado através de seu MAC addres`)
    }

    //troca de estilos
    document
        .getElementById('user-css')
        .addEventListener("change", (event) => {
            //args = (cssFile, cssLinkIndex)
            const cssFile = Array.from(["/css/claro.css", "/css/escuro.css"])[globalStyleList.options.selectedIndex];
            //cssLinkIndex)
            var oldlink = document.getElementById('dynamic-css'); //.item(cssLinkIndex);
            oldlink.setAttribute( 'href', cssFile );

            {# var newlink = document.createElement("link");
            newlink.setAttribute("rel", "stylesheet");
            newlink.setAttribute("type", "text/css");
            newlink.setAttribute("href", cssFile);
            //todo cssLinkIndex(posto 0 abaixo, ams pode variar) possa atributo do link
            const hc = document.getElementsByTagName("head");
            //cssElem = hc.getElementById( "dynamic-css");
            hc.replaceChild(newlink, oldlink); #}
        });

    window.dlgPowerHost = dlgPowerHost;
    window.dlgDeleteUnit = dlgDeleteUnit;

    window.dlgEditNewUnit = dlgEditNewUnit;
    window.dlgUpdateUnit = dlgUpdateUnit;
    window.signout = signout;

    window.onload = function (e) {}
</script>
{% endblock %}